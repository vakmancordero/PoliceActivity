<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout" layout:decorate="~{/layouts/main}">
<head>
    <title>[[#{activity.messages.list.title}]]</title>

    <th:block th:replace="fragments/datatables :: css"></th:block>

    <th:block layout:fragment="stylesheets">

        <link th:href="@{/css/activity-messages.css}" rel="stylesheet" />

    </th:block>

</head>
<div layout:fragment="content">

    <ol class="breadcrumb">
        <li class="breadcrumb-item">
            <a href="#">Home</a>
        </li>
        <li class="breadcrumb-item active">Activity Messages</li>
    </ol>

    <div class="row">
        <div class="col-12">
            <h1>[[#{module}]]</h1>
            <div id="page_content">
                <h4 class="mb-3">[[#{activity.messages.list.title}]]</h4>
                <div class="col-10">
                    <div class="row">
                        <form>
                            <div class="form-row">
                                <div class="form-group col-md-4">
                                    <label for="activityId">Activity Id</label>
                                    <input type="text" class="form-control" id="activityId" placeholder="Activity">
                                </div>
                                <div class="form-group col-md-4">
                                    <label for="environment">Environment</label>
                                    <input type="text" class="form-control" id="environment" placeholder="Environment">
                                </div>
                                <div class="form-group col-md-4">
                                    <label for="status">Status</label>
                                    <input type="text" class="form-control" id="status" placeholder="Status">
                                </div>
                            </div>
                            <div class="form-group col-md-4">
                                <button type="button" onclick="reloadTable()" class="btn btn-primary">Search</button>
                            </div>
                        </form>
                    </div>
                </div>
                <div class="col-8">
                    <div class="row">
                        <table id="activitiesTable" class="table table-bordered" style="width:100%">
                            <thead>
                            <tr>
                                <th></th>
                                <th scope="col">[[#{activity.table.id}]]</th>
                                <th scope="col">[[#{activity.table.environment}]]</th>
                            </tr>
                            </thead>
                            <tfoot>
                            <tr>
                                <th></th>
                                <th scope="col">[[#{activity.table.id}]]</th>
                                <th scope="col">[[#{activity.table.environment}]]</th>
                            </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<th:block layout:fragment="scripts">

    <th:block th:replace="fragments/datatables :: scripts"></th:block>

    <script th:inline="javascript">

        function reloadTable() {
            $('#activitiesTable').DataTable().ajax.reload();
        }

        $(function() {

            var table = $('#activitiesTable').DataTable({
                "processing": true,
                "dataType": "json",
                "ajax": {
                    "url": "/v1/activity/messages/find",
                    "type": "GET",
                    "dataSrc": "",
                    "data": function (data) {
                        data.activityId = $('#activityId').val();
                        data.status = $('#status').val();
                        data.environment = $('#environment').val();
                    }
                },
                "columns": [
                    {
                        "className": 'details-control',
                        "orderable": false,
                        "data": null,
                        "width": "15%",
                        "defaultContent": '<button style="font-size: 16px;" class="btn btn-primary"><span>Show detail</span> <i class="fas fa-plus-circle"></i></button>'
                    },
                    {"data": "activity.activityId"},
                    {"data": "activity.environment"}
                ]
            } );

            $('#activitiesTable tbody').on('click', 'td.details-control', function () {

                var tr = $(this).closest('tr');
                var row = table.row(tr);

                var showDetailButton = $(this).find('button');

                if (row.child.isShown()) {

                    showDetailButton.removeClass("btn-secondary").addClass("btn-primary");
                    $(showDetailButton).find("span").text("Show detail");
                    showDetailButton.find("i").removeClass("fa-minus-circle").addClass("fa-plus-circle");

                    row.child.hide();
                    tr.removeClass('shown');

                } else {

                    showDetailButton.removeClass("btn-primary").addClass("btn-secondary");
                    $(showDetailButton).find("span").html("Hide detail");
                    showDetailButton.find("i").removeClass("fa-plus-circle").addClass("fa-minus-circle");

                    var data = row.data();

                    var tableId = data.activity.activityId.replace(" ", "").toLowerCase();
                    var subTableId = "subtable-" + tableId;

                    row.child(format(subTableId)).show();
                    tr.addClass('shown');

                    $('table#' + subTableId).DataTable({
                        data: data.messages,
                        columns: [
                            {data: "id"},
                            {data: "message"},
                            {data: "module.name"},
                            {
                                data: "status",
                                "render": function (data, type, row) {

                                    if (data === 'success') {
                                        return '<span style="color: rgb(71, 147, 66); font-weight: bold;">' + data + '</span>';
                                    } else {
                                        return '<span style="color: rgb(149, 32, 32); font-weight: bold;">' + data + '</span>';
                                    }
                                }
                            }
                        ],
                        searching: false,
                        paging: false,
                        ordering: false,
                        info: false
                    });

                }

            });

        });

        function format(subTableId) {
            return  '<table id="' + subTableId + '" class="display" border="0" style="width:100%;">' +
                        '<thead>' +
                            '<tr>' +
                                '<th>Id</th>' +
                                '<th>Message</th>' +
                                '<th>Module</th>' +
                                '<th>Status</th>' +
                            '</tr>' +
                        '</thead>' +
                    '</table>';
        }

    </script>

</th:block>
</html>